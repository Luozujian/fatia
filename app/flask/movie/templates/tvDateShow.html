{% extends "layout.html" %}
{% block content %}
<div class="row">
    <div class="col-md-12">
        <button type="button" class="btn btn-default" onclick="startSpider()">点击开启爬虫获取数据</button>
    </div>
</div>

<div class="row" style="margin-top: 2%">
    <div class="col-md-12">
        <div class="progress">
            <div class="progress-bar" role="progressbar" aria-valuenow="50" aria-valuemin="2" aria-valuemax="100"
                 style="min-width: 5em; width: 100%;" id="progress-bar">
                尚未启动
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="input-group">
            <input type="text" class="form-control" aria-label="..." id="searchContentInput">
            <div class="input-group-btn">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">名字 <span class="caret"></span></button>
                <ul class="dropdown-menu dropdown-menu-right">
                    <li><a href="javascript:void(0);" onclick="searchItem(1)">名字</a></li>
                    <li><a href="javascript:void(0);" onclick="searchItem(2)">导演</a></li>
                    <li><a href="javascript:void(0);" onclick="searchItem(3)">演员</a></li>
                </ul>
            </div><!-- /btn-group -->
        </div><!-- /input-group -->
    </div>
</div>

<div class="row">
    <div class="col-md-12 table-responsive">
        <table class="table table-striped table-hover table-bordered" id="myTable">
        </table>
    </div>
</div>

<div class="row">
    <div class="col-md-4" id="totalData">
    </div>
    <div class="col-md-8">
        <nav aria-label="Page navigation" style="float: right">
            <ul class="pagination pagination-lg" id="page">
            </ul>
        </nav>
    </div>
</div>

<script type="text/javascript">
    var currentPage = 1;
    var pageSize = 20;
    var totalDatas;
    var totalPage;
    var datas;
    var currentType = null;
    var currentContent = $("#searchContentInput").val();

    // 页面加载完成获取table
    $(document).ready(function () {
        getTable();
        getPage();
        //getIsRunSpirder();
    });

    //定时任务
    window.setTimeout(insertTvTotalData, 1000);

    //插入数据总量
    function insertTvTotalData() {
        s = "共 " + totalDatas + " 条数据，" + totalPage + " 页";
        console.log(s);
        $("#totalData").append(s);
    }

    //删除
    function deleteItem(id) {
        $.ajax({
            type: "POST",
            url: "http://localhost:5000/admin/tv/delete",
            data: {id: id},
            success: function (result) {
                if (result === "success") {
                    pageClick(currentPage);
                } else {
                    alert("删除失败");
                }
            }
        })
    }

    //点击翻页
    function pageClick(page) {
        currentPage = page;
        getTable();
        getPage();
    }

    //搜索
    function searchItem(id) {
        currentType = id;
        currentPage = 1;
        currentContent = $("#searchContentInput").val();
        getTable();
        getPage();
    }


    //获取表格函数
    function getTable() {
        $.ajax({
            type: "GET",
            url: "http://localhost:5000/admin/tv/table",
            data: {currentPage: currentPage, pageSize: 20, id: currentType, searchContent: currentContent},
            success: function (result) {
                datas = result;
                console.log(datas);
                var jsonObject = eval(datas);
                $(document).ready(function () {
                    $("#myTable").empty();
                    var s = "<tr>\n" +
                        "                        <td>名字</td>\n" +
                        "                        <td>评分</td>\n" +
                        "                        <td>类型</td>\n" +
                        "                        <td>导演</td>\n" +
                        "                        <td>详情</td>\n" +
                        "                        <td>删除</td>\n" +
                        "                    </tr>";
                    $("#myTable").append(s);

                    for (var i = 0; i < jsonObject.length; i++) {
                        jsonObject[i][5] = jsonObject[i][5].replace(/'/g, "")
                        jsonObject[i][5] = jsonObject[i][5].substr(1,)

                        s = "<tr>\n" +
                            "                        <td>" + jsonObject[i][1] + "</td>\n" +
                            "                        <td>" + jsonObject[i][2] + "</td>\n" +
                            "                        <td>" + jsonObject[i][3] + "</td>\n" +
                            "                        <td>" + jsonObject[i][4] + "</td>\n" +
                            "                        <td><a href='" + jsonObject[i][5] + "' onclick='getDetail()'><span class=\"glyphicon glyphicon-asterisk\" aria-hidden=\"true\"></span></a>\n</td>\n" +
                            "                        <td><a href='javascript:void(0);' onclick='deleteItem(" + jsonObject[i][0] + ")'><span class=\"glyphicon glyphicon-trash\" aria-hidden=\"true\"></span></a></td>\n" +
                            "                    </tr>";
                        $("#myTable").append(s);
                    }
                })
            }
        })
    }

    //详情页
    function getDetail() {
    }

    //获取翻页列表函数
    function getPage() {
        $.ajax({
            type: "GET",
            url: "http://localhost:5000/admin/tv/table/total",
            data: {searchContent: currentContent, id: currentType},
            success: function (result) {
                totalDatas = eval(result)[0];
                totalPage = Math.ceil(totalDatas / 20);
                $("#page").empty();
                s = "";
                if (currentPage == 1) {
                    s = "<li class=\"disabled\">\n" +
                        "                          <a href=\"#\" aria-label=\"Previous\" >\n" +
                        "                            <span aria-hidden=\"true\">&laquo;</span>\n" +
                        "                          </a>\n" +
                        "                        </li>";
                    $("#page").append(s);
                } else {
                    s = "<li>\n" +
                        "                          <a href=\"#\" aria-label=\"Previous\" onclick='pageClick(currentPage-1)'>\n" +
                        "                            <span aria-hidden=\"true\">&laquo;</span>\n" +
                        "                          </a>\n" +
                        "                        </li>";
                    $("#page").append(s);
                }
                if (totalPage <= 5) {
                    for (var i = 1; i <= totalPage; i++) {
                        s = '<li><a href="#"  onclick="pageClick(' + i + ')">' + i + '</a></li>';
                        $("#page").append(s);
                    }
                } else {
                    if (currentPage < 3) {
                        for (var i = 1; i <= 5; i++) {
                            s = '<li><a href="#"  onclick="pageClick(' + i + ')">' + i + '</a></li>';
                            if (i === currentPage) {
                                s = '<li class="active"><a href="#"  onclick="pageClick(' + i + ')">' + i + '</a></li>';
                            }
                            $("#page").append(s);
                        }
                    } else if (currentPage >= totalPage - 2) {
                        for (var i = totalPage - 4; i <= totalPage; i++) {
                            s = '<li><a href="#"  onclick="pageClick(' + i + ')">' + i + '</a></li>';
                            if (i === currentPage) {
                                s = '<li class="active"><a href="#"  onclick="pageClick(' + i + ')">' + i + '</a></li>';
                            }
                            $("#page").append(s);
                        }
                    } else {
                        for (var i = currentPage - 2; i <= currentPage + 2; i++) {
                            s = '<li><a href="#"  onclick="pageClick(' + i + ')">' + i + '</a></li>';
                            if (i === currentPage) {
                                s = '<li class="active"><a href="#"  onclick="pageClick(' + i + ')">' + i + '</a></li>';
                            }
                            $("#page").append(s);
                        }
                    }
                }

                if (currentPage == totalPage) {
                    s = "<li class=\"disabled\">\n" +
                        "                          <a href=\"#\" aria-label=\"Next\" id=\"Next\">\n" +
                        "                            <span aria-hidden=\"true\">&raquo;</span>\n" +
                        "                          </a>\n" +
                        "                        </li>";
                    $("#page").append(s);
                } else {
                    s = "<li>\n" +
                        "                          <a href=\"#\" aria-label=\"Next\" id=\"Next\" onclick=\"pageClick(currentPage+1)\">\n" +
                        "                            <span aria-hidden=\"true\">&raquo;</span>\n" +
                        "                          </a>\n" +
                        "                        </li>";
                    $("#page").append(s);
                }
            }
        })
    }

     //开启爬虫
    function startSpider() {
        setInterval(getCountDateSpider, 1000);
        $.ajax({
            type: "POST",
            url: "http://localhost:5000/admin/tv/startSpider",
            success: function (result) {
                console.log(result)
            }
        })
    }


    function getCountDateSpider() {
        $.ajax({
            type: "POST",
            url: "http://localhost:5000/admin/tv/getCountDateSpider",
            success: function (result) {
                $("#progress-bar").css("width", result);
                $("#progress-bar").html(result);
            }
        })
    }

    function getIsRunSpirder() {
        $.ajax({
            type: "GET",
            url: "http://localhost:5000/admin/tv/getIsRunSpirder",
            success: function (result) {
                console.log(result);
                if (result === "1") {
                    getCountDateSpider();
                    setInterval(getCountDateSpider, 1000);
                }
            }
        })
    }

</script>
{% endblock %}